$(function(){

var transEndEventNames = {
	'WebkitTransition' : 'webkitTransitionEnd',// Saf 6, Android Browser
	'MozTransition'    : 'transitionend',      // only for FF < 15
	'transition'       : 'transitionend'       // IE10, Opera, Chrome, FF 15+, Saf 7+
};

var Walla = {};
Walla.Slider = function(elem) {
	var t = this;
	this.transformCssStyle	= Modernizr.prefixed('transform');
	this.transitionEndEventName	= transEndEventNames[Modernizr.prefixed('transition')];
	
	this.elem				= elem;
	this.itemsWrapper		= $('.slider-items-wrapper', elem);
	this.items				= $('.slider-item', this.itemsWrapper);
	this.itemsMoved			= 0;
	this.totalItems			= 0; // set in reset method
	this.wrapperWidth		= 0; // set in reset method
	this.maskWidth			= 0; // set in reset method
	this.itemWidth			= 0; // set in reset method
	this.duringSlideInterval = null;
	this.reset();
	
	this.plugin 			= new Walla.Slider.Carousel(this); 
	this.itemsWrapper.on(this.transitionEndEventName, function(event) {
		t.slideEnd();
	});
};

Walla.Slider.prototype = {
	reset: function() {
		this.resetTotalItems();
		this.resetWrapperWidth();
		this.resetMaskWidth();
		this.resetItemWidth();
	},

	getTotalItems: function() {
		return this.totalItems;
	},
	resetTotalItems: function() {
		this.totalItems = this.items.length;
	},
	getWrapperWidth: function() {
		return this.wrapperWidth;
	},
	resetWrapperWidth: function() {
		this.wrapperWidth = this.itemsWrapper.width();
	},
	resetMaskWidth: function() {
		this.maskWidth = this.itemsWrapper.width();
	},
	getItemWidth: function() {
		return this.itemWidth;
	},
	resetItemWidth: function() {
		this.itemWidth = $('.slider-item',this.itemsWrapper).outerWidth();
	},
	getItemsMoved : function() {
		return this.itemsMoved;
	},
	setItemsMoved : function(itemsMoved) {
		this.itemsMoved = itemsMoved;
	},

	slideForward: function() {
		this.itemsMoved = this.itemsMoved + 5;
		this.slide();
	},
	
	slideBackward: function() {
		this.itemsMoved = this.itemsMoved - 5;
		this.slide();
	},
	duringSlide: function() {
		var transformMatrix = this.itemsWrapper.css(this.transformCssStyle);
		var matrixArr = transformMatrix.replace(/\s/g,'').match(/(-?\d*\.?\d+),(-?\d*\.?\d+),(-?\d*\.?\d+),(-?\d*\.?\d+),(-?\d*\.?\d+),(-?\d*\.?\d+)/);
		var translatex = matrixArr[5];
		if(translatex>this.itemWidth) {
			this.duringSlideInterval = clearInterval(this.duringSlideInterval);
			this.itemsWrapper.removeClass('sliding');
			this.itemsWrapper.append($('.slider-item',this.itemsWrapper)[0]);
//			this.itemsWrapper.css(this.transformCssStyle,'translatex('+(translatex-this.itemWidth)+'px)');
//			this.itemsMoved--;
//			this.slide();
		}
		if(translatex==(this.itemsMoved*this.itemWidth)) {
			this.duringSlideInterval = clearInterval(this.duringSlideInterval);
		}
	},
	slideEnd : function() {
		this.itemsWrapper.removeClass('sliding');
		this.plugin.slideEnd();
	},
	slide: function() {	
		var t = this;
//		setTimeout(function(){
		t.itemsWrapper.addClass('sliding').css(t.transformCssStyle,'translatex('+(t.itemsMoved*t.itemWidth)+'px)');
//		},1);
	}
};
Walla.Slider.init = function(elem) {
	var jElem = $(elem);
	var slider = new Walla.Slider(elem);
	$('.slider-forward', jElem).on('click', function() {
		slider.slideForward();
	});

	$('.slider-backward', jElem).on('click', function() {
		slider.slideBackward();
	});
}

Walla.Slider.Carousel = function(slider) {
	this.slider = slider;
	this.originalItemsMoved = 0;
	this.startItemsMoved = 0;
	this.reset();
};

Walla.Slider.Carousel.prototype = {
	reset: function() {
		var slider = this.slider;
		slider.setItemsMoved(slider.getTotalItems());
		console.log(
			'slider.getItemsMoved():'+slider.getItemsMoved(),
			'slider.getTotalItems():'+slider.getTotalItems()
		);
		slider.itemsWrapper.css(slider.transformCssStyle,'translatex('+(slider.getTotalItems()*slider.getItemWidth())+'px)');
		slider.items.clone().prependTo(slider.itemsWrapper);
		slider.items.clone().appendTo(slider.itemsWrapper);
	},
	slideEnd: function() {
		var slider = this.slider;
		slider.itemsWrapper
			.html(slider.items)
			.css(slider.transformCssStyle,'translatex(0px)');
		var itemsReposition = slider.getItemsMoved()-slider.getTotalItems();
		if (itemsReposition>=0) {
			for(var i=0;l=itemsReposition,i<l;i++) {
				slider.itemsWrapper.append(slider.items[i]);
			}
		}
		else {

			var totalItems = slider.getTotalItems();
			var prependItems = [];
			for(var i=0;l=((0-1)*itemsReposition),i<l;i++) {
				prependItems.push(slider.items[totalItems-i-1]);
			}
			prependItems = prependItems.reverse();
			slider.itemsWrapper.prepend(prependItems);
		}

		slider.setItemsMoved(0);
	},
	
};



Walla.Slider.init($('.slider')[0]);

});
